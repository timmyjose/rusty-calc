name: EAS / Release / Expo Update
on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (for app.json). Eg: 1.1.7'
        required: true
        type: string
  push:
    branches:
      - main
      - mobile-release-expo-update

jobs:
  build:
    name: Checkout and EAS Update
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: 18.x
          cache: yarn
          cache-dependency-path: '**/yarn.lock'

      - name: Print branch name
        run: echo ${GITHUB_REF_NAME}

      - name: Install dependencies
        working-directory: app/packages/calc
        run: yarn install

      - name: Prepare (link) Android KV Backup Agent package
        working-directory: app/packages/android-kv-backup-agent
        run: yarn prepare

      - name: Setup Expo and EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Update app.json version and commit
        if: github.event_name == 'workflow_dispatch'
        working-directory: app/packages/calc
        run: |
          CURRENT_APP_JSON_VERSION=$(jq -r '.expo.version' app.json)
          VERSION=${{ github.event.inputs.version }}
          UPDATE=$(jq -r '.update' ./src/app.json)

          git config --local user.name "github-actions[bot]"
          git config --local user.email "actions@github.com"

          if [[ "${CURRENT_APP_JSON_VERSION}" != "${VERSION}" ]]; then
            echo "Detected a different app.json version..."
            jq --arg version "$VERSION" '.expo.version = $version' app.json > app.temp.json
            mv app.temp.json app.json
            git add app.json
            git commit -m "chore: release $VERSION ($UPDATE)"
          else
            # update src/app.json's `update` field?
            echo "Detected the same app.json version.."
            UPDATE=$((UPDATE + 1))
            jq --arg update "$UPDATE" '.update = $update'  src/app.json > app.temp.json
            mv app.temp.json src/app.json
            git add src/app.json
            git commit -m "chore: release $VERSION ($UPDATE)"
          fi
        
      - name: Push commit
        if: github.event_name == 'workflow_dispatch'
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GH_PAT }}
          branch: ${{ github.ref }}

      - name: Print branch name
        run: echo ${{ github.ref }}

      - name: Perform eas update (workflow dispatch)
        if: github.event_name == 'workflow_dispatch'
        working-directory: app/packages/calc
        run: eas update --channel=production --message="$(git log -1 --pretty=%B)"

      - name: Perform eas update (main)
        if:  github.ref_name == 'main'
        working-directory: app/packages/calc
        run: eas update --channel=production --message="$(git log -1 --pretty=%B)"

      - name: Perform eas update (mobile-release-expo-update)
        if: github.ref_name  == 'mobile-release-expo-update'
        working-directory: app/packages/calc
        run: eas update --auto
